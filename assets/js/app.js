/* SmartStudy PRO JS (simplified) */
const ADMIN_PASS='smartstudy2025';const STORAGE_KEY='smartstudy_pro_catalog_v1';function qs(s){return document.querySelector(s)}function qsa(s){return Array.from(document.querySelectorAll(s))}
document.addEventListener('DOMContentLoaded',()=>{const lang=localStorage.getItem('smartstudy_lang')||'fr';applyLang(lang);if(location.pathname.endsWith('resumes.html')) initCatalog();if(location.pathname.endsWith('admin.html')) initAdmin();const fr=qs('#lang-fr'),en=qs('#lang-en');if(fr)fr.addEventListener('click',()=>applyLang('fr'));if(en)en.addEventListener('click',()=>applyLang('en'))});
function applyLang(l){qsa('[data-i18n]').forEach(el=>{const k=el.getAttribute('data-i18n');if(k){const t={fr:{home:'Accueil',resumes:'RÃ©sumÃ©s',about:'Ã€ propos',contact:'Contact',welcome:'Bienvenue sur SmartStudy',slogan:'Apprends mieux, plus vite',how:'Comment Ã§a marche',step1:'Clique sur "RÃ©sumÃ©s" pour voir la liste',step2:'Ouvre un rÃ©sumÃ© pour le lire en ligne',step3:'Achete via WhatsApp en 1 clic',available:'RÃ©sumÃ©s disponibles'},en:{home:'Home',resumes:'Resumes',about:'About',contact:'Contact',welcome:'Welcome to SmartStudy',slogan:'Learn better, faster',how:'How it works',step1:'Click "Resumes" to see the list',step2:'Open a resume to read it online',step3:'Buy via WhatsApp in 1 click',available:'Available summaries'}};if(t[l]&&t[l][k])el.innerText=t[l][k]}});localStorage.setItem('smartstudy_lang',l)}
function loadCatalog(){try{const r=localStorage.getItem(STORAGE_KEY);if(!r)return[];return JSON.parse(r)}catch(e){return[]}}function saveCatalog(c){localStorage.setItem(STORAGE_KEY,JSON.stringify(c))}
function initCatalog(){let list=loadCatalog();if(list.length===0){list=[{title:'RÃ©sumÃ© Ã‰lectronique Analogique',file:'resume_electronique_analogique.pdf',price:10},{title:'TD Ã‰lectronique Analogique',file:'td_electronique_analogique.pdf',price:15},{title:'Ã‰lectrotechnique',file:'electrotechnique.pdf',price:20}];saveCatalog(list)}const catalog=qs('#catalog');catalog.innerHTML='';list.forEach(it=>{const card=document.createElement('div');card.className='card';card.innerHTML=`<div><h3>${it.title}</h3><p class="muted">${it.file} â€” ${it.price} DH</p></div><div class="actions"><button class="primary view" data-file="${it.file}">Voir</button><a class="buy" href="#" data-title="${it.title}" data-price="${it.price}">Acheter</a></div>`;catalog.appendChild(card)});qsa('.card .view').forEach(b=>b.addEventListener('click',ev=>{const file=ev.currentTarget.dataset.file;openPdf(file)}));qsa('.card .buy').forEach(a=>a.addEventListener('click',ev=>{ev.preventDefault();const title=a.dataset.title;const price=a.dataset.price;const msg=`Bonjour ðŸ‘‹, je souhaite acheter le rÃ©sumÃ© ${title} Ã  ${price} DH.`;window.open(`https://wa.me/212699289590?text=${encodeURIComponent(msg)}`,'_blank')}))}
async function openPdf(file){const url='pdfs/'+file;try{const r=await fetch(url);if(!r.ok)throw new Error('Not found');const arr=await r.arrayBuffer();const loading=pdfjsLib.getDocument({data:arr});const pdf=await loading.promise;const page=await pdf.getPage(1);const viewport=page.getViewport({scale:1.2});const canvas=qs('#pdf-canvas');canvas.width=viewport.width;canvas.height=viewport.height;await page.render({canvasContext:canvas.getContext('2d'),viewport}).promise;qs('#viewer-title').innerText=file;qs('#viewer').style.display='flex';qs('#viewer').setAttribute('aria-hidden','false')}catch(e){alert("Impossible d'ouvrir le fichier. Assure-toi que le PDF existe dans /pdfs et que le nom est correct.")}qs('#close-view').onclick=()=>{qs('#viewer').style.display='none';qs('#viewer').setAttribute('aria-hidden','true')}
}
function initAdmin(){const auth=qs('#auth-box'),panel=qs('#admin-panel'),pass=qs('#admin-pass'),login=qs('#admin-login'),msg=qs('#auth-msg'),add=qs('#add-file'),title=qs('#file-title'),name=qs('#file-name'),price=qs('#file-price'),listEl=qs('#list-files'),logout=qs('#logout');function refresh(){const c=loadCatalog();listEl.innerHTML='';c.forEach((it,i)=>{const li=document.createElement('li');li.innerHTML=`<strong>${it.title}</strong> â€” <span class='muted'>${it.file} â€” ${it.price} DH</span> <button data-idx='${i}' class='remove'>Supprimer</button>`;listEl.appendChild(li)});qsa('.remove').forEach(b=>b.addEventListener('click',()=>{const idx=Number(b.dataset.idx);const a=loadCatalog();a.splice(idx,1);saveCatalog(a);refresh()}))}
login.addEventListener('click',()=>{if(pass.value===ADMIN_PASS){auth.style.display='none';panel.style.display='block';refresh()}else msg.innerText='Mot de passe incorrect'});add.addEventListener('click',()=>{const t=title.value.trim(),f=name.value.trim(),p=Number(price.value.trim());if(!t||!f||!p){alert('ComplÃ¨te le titre, nom du fichier et prix (ex: 10)');return}fetch('pdfs/'+f,{method:'HEAD'}).then(res=>{if(!res.ok){alert('Le fichier semble introuvable dans /pdfs');return}const a=loadCatalog();a.push({title:t,file:f,price:p});saveCatalog(a);title.value='';name.value='';price.value='';alert('RÃ©sumÃ© ajoutÃ© ! (recharge la page RÃ©sumÃ©s pour voir la mise Ã  jour)');refresh()}).catch(()=>{alert('Le fichier semble introuvable dans /pdfs')})});logout.addEventListener('click',()=>{panel.style.display='none';auth.style.display='block';pass.value='';msg.innerText=''});
}